CREATE OR REPLACE TRIGGER CHECk_CHUC_VU
BEFORE INSERT OR UPDATE ON NHAN_VIEN
FOR EACH ROW
BEGIN 
    IF (:NEW.CHUC_VU NOT IN ('BEP','QUAN_LY','THU_NGAN')) THEN
    RAISE_APPLICATION_ERROR(-20000,'CHUC VU CUA NHAN VIEN PHAI LA BEP HOAC QUAN_LY HOAC THU_NGAN');
    END IF;
END;

CREATE OR REPLACE TRIGGER CHECK_DAT_ONLINE
BEFORE INSERT OR UPDATE ON DON_HANG
FOR EACH ROW
BEGIN 
    IF( :NEW.DAT_ONLINE NOT IN (1,0)) THEN
    RAISE_APPLICATION_ERROR(-20000,'Trang thai dat online chi co the la 1 hoac 0');
    END IF;
END;   

CREATE OR REPLACE TRIGGER CHECK_NGUYEN_LIEU
BEFORE INSERT OR UPDATE ON DON_HANG
FOR EACH ROW
DECLARE
    TOTAL INT;
    SO_LUONG_CON_LAI INT;
    SO_LUONG_CAN_THIET INT;
    SO_LUONG_MON_AN INT;
    TEN_MON MON_AN.TEN_MON%TYPE;
    CURSOR C1 IS 
        SELECT TEN_MON, CHITIET_DON.SOLUONG, NGUYEN_LIEU_MON_AN.SO_LUONG, SO_LUONG_TRONG_KHO
        FROM DON_HANG, MON_AN, CHITIET_DON, NGUYEN_LIEU_MON_AN, NGUYEN_LIEU
        WHERE DON_HANG.ID=CHITIET_DON.ID_DON
              AND CHITIET_DON.ID_MON = MON_AN.ID
              AND MON_AN.ID=NGUYEN_LIEU_MON_AN.ID_MON
              AND NGUYEN_LIEU_MON_AN.ID_NL=NGUYEN_LIEU.ID
              AND NGUYEN_LIEU_MON_AN.SO_LUONG*CHITIET_DON.SOLUONG > SO_LUONG_TRONG_KHO;
BEGIN 
    
    OPEN C1;
    TOTAL := C1%ROWCOUNT;
    IF(TOTAL > 0) THEN
    RAISE_APPLICATION_ERROR(-20000,'1 so mon an sau khong du nguyen lieu de che bien');
    LOOP
        FETCH C1 INTO TEN_MON, SO_LUONG_MON_AN, SO_LUONG_CON_LAI, SO_LUONG_CAN_THIET;
        EXIT WHEN C1%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE(TEN_MON);
    END LOOP;
    END IF;
    CLOSE C1;
END;


CREATE OR REPLACE TRIGGER CHECK_QUAN_LY 
BEFORE INSERT OR UPDATE ON NHAN_VIEN 
FOR EACH ROW
DECLARE
  cnt NUMBER;
BEGIN 
  SELECT COUNT(*) INTO cnt FROM NHAN_VIEN WHERE ID = :NEW.ID_QUAN_LY;
  IF(cnt = 0) THEN
    RAISE_APPLICATION_ERROR(-20000,'Nhan vien quan ly phai la 1 nhan vien (id cua nhan vien quan ly phai nam trong id cua nhan vien)');
  END IF;
END;


CREATE OR REPLACE TRIGGER CHECK_SO_BAN
BEFORE INSERT OR UPDATE ON DON_HANG
FOR EACH ROW
DECLARE
TOTAL NUMBER;
BEGIN 
    SELECT DISTINCT COUNT(SO_BAN_TAO_DON) INTO TOTAL FROM DON_HANG;
    IF(TOTAL >=30) THEN
    RAISE_APPLICATION_ERROR(-20000,'Hien quan da het ban xin quy khach vui long doi den khi co ban trong');
    END IF;
END;